on:
  schedule:
    - cron: "5 5 * * *"
  workflow_dispatch:
    inputs:
      job:
        description: "Which OJS workflow job to run?"
        required: true
        type: choice
        options:
          - ojs-main
          - ojs-stable-3_5_0
          - ojs-stable-3_4_0
          - ojs-stable-3_3_0
      database:
        description: "Select database"
        required: true
        type: choice
        options:
          - mysql
          - pgsql
          - mariadb

name: schedule

jobs:
  # Shared logging job (always runs first)
  log-selection:
    runs-on: ubuntu-latest
    outputs:
      job: ${{ steps.export.outputs.job }}
      database: ${{ steps.export.outputs.database }}
    steps:
      - name: üîç Echo inputs
        run: |
          echo "üîç Selected job: ${{ inputs.job }}"
          echo "üîç Selected database: ${{ inputs.database }}"
      - id: export
        run: |
          echo "job=${{ inputs.job }}" >> $GITHUB_OUTPUT
          echo "database=${{ inputs.database }}" >> $GITHUB_OUTPUT

  # -------------------------
  # Generic job template macro
  # (jobs below only plug in matrix + dataset branch)
  # -------------------------

  ojs-main:
    needs: log-selection
    if: |
      github.repository == 'pkp/ojs' &&
      (github.event_name == 'schedule' || needs.log-selection.outputs.job == 'ojs-main')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php-version: 8.2
            validate: validate
            database: pgsql
            dataset_branch: main
            upgrade_test: stable-3_3_0,stable-3_4_0,stable-3_5_0
          - php-version: 8.2
            validate: validate
            database: mariadb
            dataset_branch: main
            upgrade_test: stable-3_4_0,stable-3_5_0
          - php-version: 8.2
            validate: validate
            database: mysql
            dataset_branch: main
            upgrade_test: stable-3_3_0,stable-3_4_0,stable-3_5_0
    steps:
      - name: ‚è© Skip if DB doesn't match selection
        if: matrix.database != needs.log-selection.outputs.database
        run: |
          echo "‚ùå Skipping matrix entry because:"
          echo "   ‚Ä¢ Selected database:   ${{ needs.log-selection.outputs.database }}"
          echo "   ‚Ä¢ Matrix database:     ${{ matrix.database }}"
          exit 0

      - name: üß™ Run selected matrix entry
        if: matrix.database == needs.log-selection.outputs.database
        run: |
          echo "üß™ Running OJS job: ojs-main"
          echo "   ‚Ä¢ PHP version:   ${{ matrix['php-version'] }}"
          echo "   ‚Ä¢ Database:      ${{ matrix.database }}"
          echo "   ‚Ä¢ Dataset:       ${{ matrix.dataset_branch }}"
          echo "   ‚Ä¢ Upgrade tests: ${{ matrix.upgrade_test }}"

      - uses: pkp/pkp-github-actions@v1
        if: matrix.database == needs.log-selection.outputs.database
        with:
          node_version: 20
          dataset_branch: ${{ matrix.dataset_branch }}
          DATASETS_ACCESS_KEY: ${{ secrets.DATASETS_ACCESS_KEY }}
          DEBUG_IN_TMATE: false

  # -------------------------
  # STABLE 3.5.0
  # -------------------------
  ojs-stable-3_5_0:
    needs: log-selection
    if: |
      github.repository == 'pkp/ojs' &&
      (github.event_name == 'schedule' || needs.log-selection.outputs.job == 'ojs-stable-3_5_0')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php-version: 8.2
            database: pgsql
            dataset_branch: stable-3_5_0
            upgrade_test: stable-3_3_0,stable-3_4_0
          - php-version: 8.2
            database: mariadb
            dataset_branch: stable-3_5_0
            upgrade_test: stable-3_4_0
          - php-version: 8.2
            database: mysql
            dataset_branch: stable-3_5_0
            upgrade_test: stable-3_3_0,stable-3_4_0
    steps:
      - name: ‚è© Skip if DB doesn't match selection
        if: matrix.database != needs.log-selection.outputs.database
        run: |
          echo "‚ùå Skipping matrix entry. DB mismatch."
          exit 0

      - name: üß™ Run selected matrix entry
        if: matrix.database == needs.log-selection.outputs.database
        run: |
          echo "üß™ Running ojs-stable-3_5_0"
          echo "   ‚Ä¢ PHP version:   ${{ matrix['php-version'] }}"
          echo "   ‚Ä¢ Database:      ${{ matrix.database }}"
          echo "   ‚Ä¢ Dataset:       ${{ matrix.dataset_branch }}"
          echo "   ‚Ä¢ Upgrade tests: ${{ matrix.upgrade_test }}"

      - uses: pkp/pkp-github-actions@v1
        if: matrix.database == needs.log-selection.outputs.database
        with:
          node_version: 20
          dataset_branch: ${{ matrix.dataset_branch }}
          DATASETS_ACCESS_KEY: ${{ secrets.DATASETS_ACCESS_KEY }}
          DEBUG_IN_TMATE: false

  # -------------------------
  # STABLE 3.4.0
  # -------------------------
  ojs-stable-3_4_0:
    needs: log-selection
    if: |
      github.repository == 'pkp/ojs' &&
      (github.event_name == 'schedule' || needs.log-selection.outputs.job == 'ojs-stable-3_4_0')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php-version: 8.1
            database: pgsql
            dataset_branch: stable-3_4_0
            upgrade_test: 3.1.0,stable-3_2_0,stable-3_2_1,stable-3_3_0
          - php-version: 8.1
            database: mariadb
            dataset_branch: stable-3_4_0
          - php-version: 8.1
            database: mysql
            dataset_branch: stable-3_4_0
            upgrade_test: 3.1.0,3.1.1-2,3.1.2,stable-3_2_0,stable-3_2_1,stable-3_3_0
    steps:
      - name: ‚è© Skip if DB doesn't match selection
        if: matrix.database != needs.log-selection.outputs.database
        run: |
          echo "‚ùå Skipping matrix entry. DB mismatch."
          exit 0

      - name: üß™ Run selected matrix entry
        if: matrix.database == needs.log-selection.outputs.database
        run: |
          echo "üß™ Running ojs-stable-3_4_0"
          echo "   ‚Ä¢ PHP version:   ${{ matrix['php-version'] }}"
          echo "   ‚Ä¢ Database:      ${{ matrix.database }}"
          echo "   ‚Ä¢ Dataset:       ${{ matrix.dataset_branch }}"
          echo "   ‚Ä¢ Upgrade tests: ${{ matrix.upgrade_test }}"

      - uses: pkp/pkp-github-actions@v1
        if: matrix.database == needs.log-selection.outputs.database
        with:
          node_version: 16
          dataset_branch: ${{ matrix.dataset_branch }}
          DATASETS_ACCESS_KEY: ${{ secrets.DATASETS_ACCESS_KEY }}
          DEBUG_IN_TMATE: false

  # -------------------------
  # STABLE 3.3.0
  # -------------------------
  ojs-stable-3_3_0:
    needs: log-selection
    if: |
      github.repository == 'pkp/ojs' &&
      (github.event_name == 'schedule' || needs.log-selection.outputs.job == 'ojs-stable-3_3_0')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php-version: 7.4
            database: pgsql
            dataset_branch: stable-3_3_0
          - php-version: 7.4
            database: mysql
            dataset_branch: stable-3_3_0
    steps:
      - name: ‚è© Skip if DB doesn't match selection
        if: matrix.database != needs.log-selection.outputs.database
        run: |
          echo "‚ùå Skipping matrix entry. DB mismatch."
          exit 0

      - name: üß™ Run selected matrix entry
        if: matrix.database == needs.log-selection.outputs.database
        run: |
          echo "üß™ Running ojs-stable-3_3_0"
          echo "   ‚Ä¢ PHP version:   ${{ matrix['php-version'] }}"
          echo "   ‚Ä¢ Database:      ${{ matrix.database }}"
          echo "   ‚Ä¢ Dataset:       ${{ matrix.dataset_branch }}"

      - uses: pkp/pkp-github-actions@v1
        if: matrix.database == needs.log-selection.outputs.database
        with:
          node_version: 12
          dataset_branch: ${{ matrix.dataset_branch }}
          DATASETS_ACCESS_KEY: ${{ secrets.DATASETS_ACCESS_KEY }}
          DEBUG_IN_TMATE: false
